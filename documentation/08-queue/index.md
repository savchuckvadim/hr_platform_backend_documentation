# Queue Module - Модуль очередей

## Описание

Модуль для работы с очередями задач через BullMQ (Redis-based queue). Обеспечивает асинхронную обработку тяжелых операций, retry логику, масштабируемость и мониторинг задач.

## Архитектурные принципы

### Ключевые принципы

1. **Только для тяжелых операций** - очереди используются только для операций, требующих retry, долгого выполнения или асинхронной обработки
2. **Worker только вызывает сервис** - вся бизнес-логика в сервисах, processor только координирует
3. **EventBus интеграция** - бизнес-события публикуются из `@OnWorkerEvent('completed')`
4. **Прямое использование Queue** - сервисы напрямую используют `queue.add()`, без dispatcher
5. **Разделение очередей** - каждая очередь для своего типа задач (mail, file-processing)

## Структура модуля

### Core Queue Module

```
core/queue/
├── queue.module.ts              # Глобальный модуль очередей
├── consts/
│   ├── queue-names.enum.ts      # Названия очередей
│   └── job-names.enum.ts        # Названия задач (опционально)
└── index.ts
```

### В бизнес-модулях

```
mail/
├── infrastructure/
│   └── processors/
│       └── mail.processor.ts   # Worker для обработки очереди
├── events/
│   └── mail-events.constants.ts # Константы очереди и событий
└── application/
    └── services/
        └── mail.service.ts      # Использует queue.add() напрямую
```

## Задачи

### ✅ Queue Setup
**Статус**: Завершено
**Файл**: [queue-setup.md](./queue-setup.md)
**Описание**: Настройка BullMQ и Redis для очередей

### ✅ Queue Processors
**Статус**: Завершено
**Файл**: [queue-processors.md](./queue-processors.md)
**Описание**: Обработчики задач в очередях (consumers). Важно: вся бизнес-логика в сервисах

### ✅ Adding Jobs to Queue
**Статус**: Завершено
**Файл**: [adding-jobs.md](./adding-jobs.md)
**Описание**: Как добавлять задачи в очередь из сервисов

### ✅ Retry Logic
**Статус**: Завершено
**Файл**: [retry-logic.md](./retry-logic.md)
**Описание**: Логика повторных попыток для failed задач

### ✅ Queue Monitoring
**Статус**: Завершено
**Файл**: [queue-monitoring.md](./queue-monitoring.md)
**Описание**: Мониторинг очередей и задач

### ✅ Usage Examples
**Статус**: Завершено
**Файл**: [usage-examples.md](./usage-examples.md)
**Описание**: Практические примеры использования очередей

## Ключевые концепции

- **BullMQ** - для управления очередями на основе Redis
- **Разделение очередей** - по типам задач (mail, file-processing)
- **Автоматические retry** - для failed задач с настраиваемой стратегией
- **Приоритизация задач** - через job options
- **Мониторинг** - логирование и метрики выполнения задач
- **Обработка long-running задач** - для тяжелых операций
- **Важно**: Вся бизнес-логика должна быть в сервисах, processor только координирует

## Когда использовать очереди?

Используйте очереди (BullMQ) когда:

1. **Долгие операции** - задачи, которые выполняются долго (>1 секунды)
2. **Требуется retry** - нужны повторные попытки при ошибках
3. **Асинхронная обработка** - не нужно ждать результата сразу
4. **Масштабируемость** - нужно распределить нагрузку между воркерами
5. **Очередь задач** - много задач одного типа, которые нужно обработать последовательно

**Примеры:**
- ✅ Отправка email
- ✅ Генерация отчетов
- ✅ Обработка изображений/файлов
- ✅ Интеграция с внешними API
- ✅ Массовая рассылка
- ❌ Создание уведомления в БД (быстрая операция - выполняется сразу)
- ❌ Обновление статуса (быстрая операция - выполняется сразу)

## Ссылки

- [Queue Setup](./queue-setup.md) - настройка BullMQ
- [Queue Processors](./queue-processors.md) - обработчики задач
- [Adding Jobs to Queue](./adding-jobs.md) - добавление задач в очередь
- [Retry Logic](./retry-logic.md) - логика повторных попыток
- [Queue Monitoring](./queue-monitoring.md) - мониторинг очередей
- [Usage Examples](./usage-examples.md) - практические примеры
