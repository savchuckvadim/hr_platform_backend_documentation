// Use DBML to define your database structure
// Docs: https://dbml.dbdiagram.io/docs
// HR Platform Database Schema

// ============================================
// User & Authentication
// ============================================

Table users {
  id varchar [primary key, note: 'UUID']
  email varchar(255) [unique, note: 'Unique email for authentication']
  password varchar [note: 'Hashed password']
  is_activated boolean [default: false]
  activation_link varchar(255) [unique, null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this user (for admin actions)']
  updated_by varchar [null, note: 'FK to users.id - who last updated this user']

  indexes {
    email
    created_by
    updated_by
  }
}

Table user_roles {
  id varchar [primary key, note: 'UUID']
  name varchar(50) [unique, not null, note: 'CANDIDATE | EMPLOYER | ADMIN - системные роли']
  slug varchar(50) [unique, not null]
  description text [null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']
  updated_by varchar [null, note: 'FK to users.id']

  indexes {
    name
    slug
    is_active
    created_by
    updated_by
  }
}

Table hr_roles {
  id varchar [primary key, note: 'UUID']
  name varchar(50) [unique, not null, note: 'HR | HR_ADMIN - роли внутри компании']
  slug varchar(50) [unique, not null]
  description text [null]
  permissions json [null, note: 'JSON с правами доступа для будущего расширения']
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']
  updated_by varchar [null, note: 'FK to users.id']

  indexes {
    name
    slug
    is_active
    created_by
    updated_by
  }
}

Table role_contexts {
  id varchar [primary key, note: 'UUID']
  user_id varchar [not null]
  user_role_id varchar [not null, note: 'FK to user_roles - системная роль (CANDIDATE | EMPLOYER | ADMIN)']
  company_id varchar [null, note: 'For EMPLOYER role - company they belong to. Required for EMPLOYER roles']
  hr_role_id varchar [null, note: 'FK to hr_roles - роль HR внутри компании (HR | HR_ADMIN) - только для EMPLOYER']
  created_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this role context']

  indexes {
    user_id
    user_role_id
    company_id
    hr_role_id
    created_by
  }
}

Table company_types {
  id varchar [primary key, note: 'UUID']
  name varchar(100) [unique, not null, note: 'ORGANIZATION | IP | LAWYER | SELF_EMPLOYED | OTHER']
  slug varchar(100) [unique, not null]
  description text [null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']
  updated_by varchar [null, note: 'FK to users.id']

  indexes {
    name
    slug
    is_active
    created_by
    updated_by
  }
}

Table companies {
  id varchar [primary key, note: 'UUID']
  name varchar(255) [not null]
  inn varchar(20) [null, note: 'Tax identification number']
  company_type_id varchar [not null, note: 'FK to company_types - позволяет добавлять новые типы без миграции']
  owner_id varchar [not null, note: 'User who created company (EMPLOYER with HR_ADMIN role)']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this company']
  updated_by varchar [null, note: 'FK to users.id - who last updated this company']

  indexes {
    owner_id
    inn
    company_type_id
    created_by
    updated_by
  }
}

Table tokens {
  id varchar [primary key, note: 'UUID']
  user_id varchar [not null]
  role_context_id varchar [not null, note: 'Active role context for this token']
  refresh_token varchar(500) [unique, note: 'Hashed refresh token']
  device_id varchar(255) [not null, note: 'Unique device identifier']
  device_name varchar(255) [null]
  user_agent text [null]
  ip_address varchar(45) [null]
  expires_at timestamp [not null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]

  indexes {
    user_id
    role_context_id
    refresh_token
    device_id
    expires_at
    (user_id, role_context_id, device_id) [unique, note: 'One token per user+role+device']
  }
}

// ============================================
// Profiles
// ============================================

Table candidate_profiles {
  id varchar [primary key, note: 'UUID']
  user_id varchar [unique, not null]
  first_name varchar(100) [null]
  last_name varchar(100) [null]
  middle_name varchar(100) [null]
  birthday timestamp [null]
  phone varchar(20) [null]
  contact_email varchar(255) [null]
  contact_phone varchar(20) [null]
  avatar varchar(500) [null]
  bio text [null]
  location varchar(255) [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this profile']
  updated_by varchar [null, note: 'FK to users.id - who last updated this profile']

  indexes {
    user_id
    created_by
    updated_by
  }
}

// DEPRECATED: employer_profiles больше не используется
// Вся информация о компании хранится в таблице companies
// Владелец компании = User с RoleContext (EMPLOYER, HR_ADMIN)
// Оставлено для обратной совместимости, но не должно использоваться в новой архитектуре

// ============================================
// Resumes
// ============================================

Table resumes {
  id varchar [primary key, note: 'UUID']
  candidate_id varchar [not null]
  title varchar(255) [not null]
  position varchar(255) [null]
  salary_min integer [null]
  salary_max integer [null]
  currency varchar(3) [default: 'RUB']
  contact_email varchar(255) [null, note: 'Optional override from profile']
  contact_phone varchar(20) [null, note: 'Optional override from profile']
  summary text [null]
  is_active boolean [default: true]
  is_public boolean [default: false]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this resume']
  updated_by varchar [null, note: 'FK to users.id - who last updated this resume']

  indexes {
    candidate_id
    is_active
    is_public
    created_by
    updated_by
  }
}

Table resume_versions {
  id varchar [primary key, note: 'UUID']
  resume_id varchar [not null]
  version integer [default: 1]
  data json [note: 'JSON snapshot of resume at version']
  created_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this version']

  indexes {
    resume_id
    (resume_id, version) [unique]
    created_by
  }
}

Table experiences {
  id varchar [primary key, note: 'UUID']
  resume_id varchar [not null]
  company varchar(255) [not null]
  company_id varchar [null, note: 'FK to companies.id - связь с компанией в системе (опционально)']
  position varchar(255) [not null]
  description text [null]
  start_date timestamp [not null]
  end_date timestamp [null]
  is_current boolean [default: false]
  location varchar(255) [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this experience']
  updated_by varchar [null, note: 'FK to users.id - who last updated this experience']

  indexes {
    resume_id
    company
    company_id
    position
    created_by
    updated_by
  }
}

Table educations {
  id varchar [primary key, note: 'UUID']
  resume_id varchar [not null]
  institution varchar(255) [not null]
  degree varchar(255) [null]
  field varchar(255) [null]
  start_date timestamp [null]
  end_date timestamp [null]
  description text [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this education']
  updated_by varchar [null, note: 'FK to users.id - who last updated this education']

  indexes {
    resume_id
    institution
    degree
    created_by
    updated_by
  }
}

// ============================================
// Projects & Vacancies
// ============================================

Table projects {
  id varchar [primary key, note: 'UUID']
  company_id varchar [not null, note: 'FK to companies - проект принадлежит компании']
  name varchar(255) [not null, note: 'Название проекта (например: Шаурмечная, Кофейня)']
  description text [null]
  is_active boolean [default: true]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this project']
  updated_by varchar [null, note: 'FK to users.id - who last updated this project']

  indexes {
    company_id
    is_active
    created_by
    updated_by
  }
}

Table vacancies {
  id varchar [primary key, note: 'UUID']
  project_id varchar [null, note: 'FK to projects - вакансия может быть привязана к проекту компании (необязательно)']
  title varchar(255) [not null]
  description text [not null]
  position varchar(255) [null]
  salary_min integer [null]
  salary_max integer [null]
  currency varchar(3) [default: 'RUB']
  location varchar(255) [null]
  work_type varchar [default: 'FULL_TIME', note: 'FULL_TIME | PART_TIME | CONTRACT | INTERNSHIP | REMOTE | HYBRID']
  employment_type varchar [default: 'PERMANENT', note: 'PERMANENT | TEMPORARY | CONTRACT | INTERNSHIP']
  is_active boolean [default: true]
  is_public boolean [default: true]
  expires_at timestamp [null]
  views_count integer [default: 0]
  replies_count integer [default: 0, note: 'Renamed from applications_count']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this vacancy']
  updated_by varchar [null, note: 'FK to users.id - who last updated this vacancy']

  indexes {
    project_id
    is_active
    is_public
    work_type
    employment_type
    expires_at
    created_by
    updated_by
  }
}

// ============================================
// Replies (formerly Applications)
// ============================================

Table replies {
  id varchar [primary key, note: 'UUID']
  candidate_id varchar [not null]
  vacancy_id varchar [not null]
  resume_id varchar [null]
  resume_version_id varchar [null]
  status varchar [default: 'NEW', note: 'NEW | VIEWED | INVITED | REJECTED | ACCEPTED | WITHDRAWN']
  cover_letter text [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this reply']
  updated_by varchar [null, note: 'FK to users.id - who last updated this reply']

  Note: 'Unique constraint: (candidate_id, vacancy_id) - One reply per candidate per vacancy'

  indexes {
    candidate_id
    vacancy_id
    status
    created_at
    created_by
    updated_by
    (candidate_id, vacancy_id) [unique]
  }
}

// ============================================
// Skills
// ============================================

Table skills {
  id varchar [primary key, note: 'UUID']
  name varchar(100) [unique, not null]
  slug varchar(100) [unique, not null]
  category varchar(50) [null]
  description text [null]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']
  updated_by varchar [null, note: 'FK to users.id']

  indexes {
    name
    slug
    category
    created_by
    updated_by
  }
}

Table resume_skills {
  id varchar [primary key, note: 'UUID']
  resume_id varchar [not null]
  skill_id varchar [not null]
  level varchar [null, note: 'BASIC | INTERMEDIATE | ADVANCED | EXPERT']
  created_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']

  indexes {
    resume_id
    skill_id
    created_by
    (resume_id, skill_id) [unique]
  }
}

Table vacancy_skills {
  id varchar [primary key, note: 'UUID']
  vacancy_id varchar [not null]
  skill_id varchar [not null]
  is_required boolean [default: false]
  level varchar [null, note: 'BASIC | INTERMEDIATE | ADVANCED | EXPERT']
  created_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id']

  indexes {
    vacancy_id
    skill_id
    created_by
    (vacancy_id, skill_id) [unique]
  }
}

// ============================================
// Chat & Messages
// ============================================

Table chats {
  id varchar [primary key, note: 'UUID']
  reply_id varchar [unique, null, note: 'FK to replies.id - renamed from application_id']
  type varchar [default: 'DIRECT', note: 'DIRECT | APPLICATION | GROUP']
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this chat']
  updated_by varchar [null, note: 'FK to users.id - who last updated this chat']

  indexes {
    reply_id
    type
    created_by
    updated_by
  }
}

Table chat_members {
  id varchar [primary key, note: 'UUID']
  chat_id varchar [not null]
  user_id varchar [not null]
  role varchar [default: 'MEMBER', note: 'MEMBER | ADMIN | OWNER']
  joined_at timestamp [default: `now()`]
  left_at timestamp [null]
  last_read_at timestamp [null]

  indexes {
    chat_id
    user_id
    (chat_id, user_id) [unique]
  }
}

Table messages {
  id varchar [primary key, note: 'UUID']
  chat_id varchar [not null]
  user_id varchar [not null]
  content text [not null]
  type varchar [default: 'TEXT', note: 'TEXT | IMAGE | FILE | SYSTEM']
  file_id varchar [null]
  reply_to_id varchar [null]
  is_edited boolean [default: false]
  is_deleted boolean [default: false]
  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who created this message (usually same as user_id)']
  updated_by varchar [null, note: 'FK to users.id - who last updated this message']

  indexes {
    chat_id
    user_id
    created_at
    created_by
    updated_by
  }
}

// ============================================
// Files
// ============================================

Table files {
  id varchar [primary key, note: 'UUID']
  user_id varchar [not null]
  name varchar(255) [not null]
  original_name varchar(255) [not null]
  mime_type varchar(100) [not null]
  size integer [not null]
  url varchar(500) [not null]
  s3_key varchar(500) [not null]
  type varchar [not null, note: 'RESUME | DOCUMENT | AVATAR | IMAGE | VACANCY_IMAGE']
  created_at timestamp [default: `now()`]
  created_by varchar [null, note: 'FK to users.id - who uploaded this file']

  indexes {
    user_id
    type
    created_at
    created_by
  }
}


// ============================================
// Relationships
// ============================================

// User relationships
Ref: role_contexts.user_id > users.id [delete: cascade]
Ref: role_contexts.user_role_id > user_roles.id [delete: restrict]
Ref: role_contexts.hr_role_id > hr_roles.id [delete: set null]
Ref: tokens.user_id > users.id [delete: cascade]
Ref: tokens.role_context_id > role_contexts.id [delete: cascade]
Ref: candidate_profiles.user_id > users.id [delete: cascade]
// DEPRECATED: employer_profiles больше не используется
Ref: chat_members.user_id > users.id [delete: cascade]
Ref: messages.user_id > users.id [delete: cascade]
Ref: files.user_id > users.id [delete: cascade]
Ref: replies.candidate_id > users.id [delete: cascade]
// Note: ReplyCandidate relation

// Self-referencing for created_by/updated_by
Ref: users.created_by > users.id [delete: set null]
Ref: users.updated_by > users.id [delete: set null]
Ref: user_roles.created_by > users.id [delete: set null]
Ref: user_roles.updated_by > users.id [delete: set null]
Ref: hr_roles.created_by > users.id [delete: set null]
Ref: hr_roles.updated_by > users.id [delete: set null]
Ref: role_contexts.created_by > users.id [delete: set null]
Ref: company_types.created_by > users.id [delete: set null]
Ref: company_types.updated_by > users.id [delete: set null]
Ref: companies.created_by > users.id [delete: set null]
Ref: companies.updated_by > users.id [delete: set null]
Ref: candidate_profiles.created_by > users.id [delete: set null]
Ref: candidate_profiles.updated_by > users.id [delete: set null]
Ref: resumes.created_by > users.id [delete: set null]
Ref: resumes.updated_by > users.id [delete: set null]
Ref: resume_versions.created_by > users.id [delete: set null]
Ref: experiences.created_by > users.id [delete: set null]
Ref: experiences.updated_by > users.id [delete: set null]
Ref: experiences.company_id > companies.id [delete: set null]
Ref: educations.created_by > users.id [delete: set null]
Ref: educations.updated_by > users.id [delete: set null]
Ref: projects.created_by > users.id [delete: set null]
Ref: projects.updated_by > users.id [delete: set null]
Ref: vacancies.created_by > users.id [delete: set null]
Ref: vacancies.updated_by > users.id [delete: set null]
Ref: replies.created_by > users.id [delete: set null]
Ref: replies.updated_by > users.id [delete: set null]
Ref: skills.created_by > users.id [delete: set null]
Ref: skills.updated_by > users.id [delete: set null]
Ref: resume_skills.created_by > users.id [delete: set null]
Ref: vacancy_skills.created_by > users.id [delete: set null]
Ref: chats.created_by > users.id [delete: set null]
Ref: chats.updated_by > users.id [delete: set null]
Ref: messages.created_by > users.id [delete: set null]
Ref: messages.updated_by > users.id [delete: set null]
Ref: files.created_by > users.id [delete: set null]

// Company relationships
Ref: companies.owner_id > users.id [delete: cascade]
// Note: Нельзя удалить тип компании если есть компании этого типа
Ref: companies.company_type_id > company_types.id [delete: restrict]
Ref: role_contexts.company_id > companies.id [delete: set null]

// Profile relationships
Ref: resumes.candidate_id > candidate_profiles.id [delete: cascade]

// Resume relationships
Ref: resume_versions.resume_id > resumes.id [delete: cascade]
Ref: experiences.resume_id > resumes.id [delete: cascade]
Ref: educations.resume_id > resumes.id [delete: cascade]
Ref: resume_skills.resume_id > resumes.id [delete: cascade]
Ref: replies.resume_id > resumes.id [delete: set null]
Ref: replies.resume_version_id > resume_versions.id [delete: set null]

// Project & Vacancy relationships
Ref: projects.company_id > companies.id [delete: cascade]
Ref: vacancies.project_id > projects.id [delete: set null, note: 'Optional - vacancy can exist without project']
Ref: replies.vacancy_id > vacancies.id [delete: cascade]
Ref: vacancy_skills.vacancy_id > vacancies.id [delete: cascade]

// Skill relationships
Ref: resume_skills.skill_id > skills.id [delete: cascade]
Ref: vacancy_skills.skill_id > skills.id [delete: cascade]

// Reply relationships (formerly Application)
Ref: chats.reply_id > replies.id [delete: cascade]
// Note: Reply -> Company relationship is via vacancy.project_id -> projects.company_id -> companies.id

// Chat relationships
Ref: chat_members.chat_id > chats.id [delete: cascade]
Ref: messages.chat_id > chats.id [delete: cascade]

// Message relationships
Ref: messages.file_id > files.id [delete: set null]
Ref: messages.reply_to_id > messages.id [delete: set null]
// Note: Self-referencing for message replies

// Unique constraints are defined in table indexes above
